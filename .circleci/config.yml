version: 2

machine:
    services:
        - docker

jobs:
    build:
        machine:
            docker_layer_caching: true
        steps:
            - checkout
            - run:
                  name: Build First Stage Container
                  command: |
                      TAG=$CIRCLE_SHA1.$CIRCLE_BUILD_NUM
                      docker build --target=builder -t kleiberd93/budapest-car-sharing-backend:$TAG .

            - run:
                  name: Run tests
                  command: |
                      TAG=$CIRCLE_SHA1.$CIRCLE_BUILD_NUM
                      docker run kleiberd93/budapest-car-sharing-backend:$TAG go test